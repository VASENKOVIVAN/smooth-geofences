# smooth-geofences

![Фото 0 (Сколько бы раз не писал замещающий текст он еще ни разу не пригодился, так что вряд ли это кто то увидит).](/assets/images/0.jpg)

Скругление углов объектов системы `WGS84`

Принимаем массив координат `WGS84` вида `[[lat, lon], [lat, lon], ...]`

Переводим координаты из `WGS84` в проекцию Меркатора (сферическая псевдо-меркаторская проекция)

Получаем массив координат Mercator вида `[[x, y], [x, y], ...]`

Рассмотрим процесс скругления для фигуры на примере угла образующего сторонами `AB-AG`:

![Фото 1.](/assets/images/1.jpg)

## 1 шаг
Вычисляем длины сторон вершины текущего угла, в частности, интересует короткая сторона (в данном случае `AB`)

## 2 шаг
В главном файле `config` есть параметр `VALUE_ROUNDED` (радиус скругления угла) принимающий значения `от 0.00001 до 0.5`

Этот параметр определяет в процентном соотношении расстояние точки лежащей на короткой стороне удаленной от вершины угла

Таким образом, при `VALUE_ROUNDED=0.5`, точка `H` будет лежать на середине короткой стороны `AB`

При `VALUE_ROUNDED=0.25`, точка `H` будет лежать на расстоянии 1/4 от длины короткой стороны `AB`

Так же получим длину отрезка `AH`

![Фото 2.](/assets/images/2.jpg)

## 3 шаг
Найдем точку `I` на длинной стороне `AG` лежащую на таком же расстоянии `AH`

![Фото 3.](/assets/images/3.jpg)
## 4 шаг
Найдем уравнения перпендикулярных прямых `ax + by + c = 0`

Решим систему уравнений, получим точку пересечения перпендикуляров `J`

![Фото 4.](/assets/images/4.jpg)

## 5 шаг
Построим окружность с центром в точке `J` и точками `Р` и `I` лежащими на ней

Вычислим радиус окружности `(R: JH)`

Зная координаты точки и радиус можно получить градус угла `α` на котором лежит точка `H`

`rad = acos(Hx/R-Jx/R)`, переведем в градусы `(rad/(pi/180))`

## 6 шаг
Получим угол `IJH` (`β`)

![Фото 5.](/assets/images/5.jpg)

## 7 шаг
В главном файле `config` есть параметр `VALUE_ROUND_PARAMETR` (детализация скругления угла, количество точек) принимающий значения `от 1`

Например:

`VALUE_ROUND_PARAMETR=4`

Тогда:
- разделим угол `β` на 4 и прибавим это значение к углу `α`, получим точку `R`, лежащую на окружности 
- разделим угол `β` на 4, умножим на 2, и прибавим это значение к углу `α`, получим точку `N`, лежащую на окружности
- разделим угол `β` на 4, умножим на 3, и прибавим это значение к углу `α`, получим точку `Q`, лежащую на окружности

## 8 шаг
Соединим полученные точки:

![Фото 6.](/assets/images/6.jpg)

Заменим точку исходной вершины на полученные точки `I, Q, N, R, H` - получили скругленный угол

## 9 шаг
Пример угла при `VALUE_ROUND_PARAMETR=16`

![Фото 7.](/assets/images/7.jpg)

> Проделываем тоже самое с каждым углом


## 10 шаг
Переводим массив полученных точек обратно в `WGS84`, получаем скругленную геозону


# Описание проекта:

`pip install -r requirements.txt`

## 1 шаг
`app.py` (entrypoint)

В массив arrData вставляем координаты

## 2 шаг
В `config.py` меняем параметры `VALUE_ROUNDED`, `VALUE_ROUND_PARAMETR`, `REVERSE_LAT_LON`

Предполагается, что массив точек состоит из: `[[lat, lon], [lat, lon], [lat, lon]]`

Если по какой то причине исходный массив реверсивен: `[[lon, lat], [lon, lat], [lon, lat]]`

То установите `REVERSE_LAT_LON=True`

`python app.py` - выведет в консоль массив координат преобразованной геозоны

# Описание модуля для Rightech:

`pip install -r requirements.txt`

## 1 шаг
`app_rightech.py` (entrypoint)

## 2 шаг
В `config.py` меняем параметры `VALUE_ROUNDED`, `VALUE_ROUND_PARAMETR`, `REVERSE_LAT_LON`

>Предполагается, что массив точек состоит из: `[[lat, lon], [lat, lon], [lat, lon]]`

>Если по какой то причине исходный массив реверсивен: `[[lon, lat], [lon, lat], [lon, lat]]`

>То установите `REVERSE_LAT_LON=True`

## 3 шаг
Установите переменную окружения `TOKEN_API` (API key Rightech)

## 4 шаг
В `config_get.py` установите `ID_GEOFENCE` id геозоны, которую требуется скруглить

## 5 шаг
В `config_post.py` установите:

`DEFAUL_GEOFENSE_PARAMS: bool`
> Перенести все стили с полученной геозоны

> Если `True`  - перенесет все стили из полученной зоны

> Если `False` - применит к создаваемой геозоне параметры определенные ниже

Если `DEFAUL_GEOFENSE_PARAMS = False`, то к названию геозоны добавим `GEOFENSE_NAME_POSTFIX: str` постфикс, например - `' копия'`

`GEOFENSE_NAME: str` (название геозоны)

`GEOFENSE_COLOR: str` (цвет геозоны `#3CC1D4`)

`GEOFENSE_STYLE_FILLOPACITY: float` (прозрачность заливки [0; 1])

`GEOFENSE_STYLE_OPACITY: float` (прозрачность рамки [0; 1])

`GEOFENSE_STYLE_WEIGHT: int` (толщина рамки)

`GEOFENSE_SHAPE_TYPE = "polygon"`

Затем, `python app_rightech.py` - получит данные о геозоне, сделает новую скругленную геозону, и отправит ее на платформу Rightech
